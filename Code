# @title üöÄ AQA A-Level Workflow (Verified GenAI SDK Version)
# ==============================================================================
# 1. SYSTEM SETUP
# ==============================================================================
# We install the NEW library that supports the search tools correctly
import os
import markdown
import re  # <--- Add this if it's missing!

!pip install -q -U google-genai markdown

from google import genai
from google.genai import types
from google.colab import drive
from google.colab import files
import os
# removed: import markdown # Import the markdown library

# --- MOUNT GOOGLE DRIVE ---
try:
    drive.mount('/content/drive')
except Exception:
    print("‚ö†Ô∏è Drive already mounted.")

drive_folder = "/content/drive/My Drive/AQA_Revision"
os.makedirs(drive_folder, exist_ok=True)

# ==============================================================================
# 2. CONFIGURATION
# ==============================================================================

GEMINI_API_KEY = "" # <--- PASTE KEY HERE

# --- INJECTION 1: THE AQA GRAPH ENGINE SYSTEM PROMPT ---
PROMPT_GRAPH_ENGINE = """
*** ROLE ***
You are the "AQA Economics Graph Engine." Your sole purpose is to generate Python `matplotlib` code.

*** AQA STYLE GUIDE ***
1. LIBRARY: Use `matplotlib.pyplot` as `plt` and `numpy` as `np`.
2. AESTHETICS:
   - Background: White.
   - Axes: Spines `top`/`right` invisible. `left`/`bottom` black.
   - Labels: Font size 12. X-axis='Quantity' (or 'Real GDP'), Y-axis='Price' (or 'PL').
   - Colors: Blue (#1f77b4) for Initial Curves, Red (#d62728) for Shifted Curves, Grey for Dotted Drop-lines.
3. EXECUTION RULES:
   - CALCULATE coordinates (don't guess). Use `np.linspace`.
   - LABEL equilibrium points (P1, Q1) with dotted drop-lines to the axes.
   - RETURN ONLY raw Python code. No markdown backticks, no text explanations.
   - IMPLICIT KNOWLEDGE: If asked for "Monopoly", automatically plot AR, MR, AC, MC correctly.
"""

# ------------------------------------------------------------------------------
# PROMPTS
# ------------------------------------------------------------------------------
PROMPT_1_FIND_SOURCE = """
Act as an expert AQA A-Level Researcher for the topic: {topic}.

SEARCH PROTOCOL:
1. Use Google Search to find high-quality revision content.
2. PRIORITY DOMAINS: 'Physics & Maths Tutor' (PMT), 'Save My Exams', 'Tutor2u'.
3. STRICT CONSTRAINT: Filter for **AQA Specification** only. Ignore Edexcel/OCR content.

EXTRACTION TASK:
- Do not summarize; extract DETAILED educational content.
- MANDATORY SECTIONS TO FIND:
  - Exact Definitions (AQA wording).
  - Core Theories/Mechanisms (How it works).
  - Key Studies/Case Studies (if applicable).
  - Evaluation/Analysis Points (Strengths, Weaknesses, Limitations).
"""

PROMPT_2_CREATE_NOTES = """
### ROLE & GOAL
Act as a Senior Chief Examiner for AQA A-Level {topic}. Your goal is to convert the provided topic into "High-Yield Exam Notes" that are strictly spec-aligned and optimized for active recall.

### SOURCE MATERIAL (USE THIS ONLY)
{source_text}

### NON-NEGOTIABLE CONSTRAINTS
1.  **No Prose:** Use bullet fragments and logic chains only.
2.  **Spec-Check:** List the exact AQA spec points covered at the top.
3.  **AO Separation:** Distinctly label sections as [AO1 Knowledge], [AO2 Application], [AO3 Analysis], [AO4 Evaluation].

### SUBJECT-SPECIFIC ARCHITECTURE (Choose one based on Subject)

**IF ECONOMICS:**
* **AO3 Chains:** Must use arrows (‚Üí) to show transmission mechanisms.If there is a relevant diagram, diagram analysis should be integrated into the chains.
 * **Diagrams:** CRITICAL: You must identify where a diagram is needed and insert this tag: {{DRAW: <Exact Name of Diagram>}}.
   - Example: {{DRAW: Negative Externality in Production}}
   - Example: {{DRAW: J-Curve Effect}}
* **Evaluation:** Use the "EV" tag for "Depends on" factors (e.g., Elasticity, Time lag).


**IF BUSINESS:**
* **Context Hooks:** For every concept, provide 1 real-world brand example (e.g., Apple, Tesla).
* **Evaluation:** Use "MOPS" structure (Market, Objectives, Product, Situation) to frame arguments.

**IF PSYCHOLOGY:**
* **AO1 Details:** For studies, strictly list: Aim | Procedure | Findings | Conclusion.
* **AO3 PEEL:** Provide 3 distinct evaluation points. Label them: `[Strength]` or `[Limitation]`. Tag relevant "Issues & Debates" (e.g., [Reductionism]).

### OUTPUT FORMAT EXAMPLE (Few-Shot)
*Topic: Price Elasticity of Demand (Economics)*
**[Spec]** 4.1.1.5 PED numerical values and factors.
**[AO1]**
* **Def:** %ŒîQD / %ŒîP.
* **Values:** >1 Elastic, <1 Inelastic.
**[AO3 Chain]**
* Price ‚Üë ‚Üí Substitutes available? (Yes) ‚Üí Consumers switch ‚Üí QD falls significantly ‚Üí Revenue ‚Üì.
**[AO4 Evaluation]**
* **Depends on Time:** SR (Inelastic/Habit) vs LR (Elastic/Switching).


"""

PROMPT_3_CREATE_ANKI = """
Based on the notes above, create an Anki CSV.

[System Role & Objective
You are an expert AQA A-Level Study Assistant and Flashcard Engineer. Your goal is to convert PDF notes into high-performance Anki flashcards that guarantee full-marks/top-band exam performance.
Core Workflow:
1. Analyze (Internal): Read notes, clean clutter, and map to the AQA Specification to ensure coverage.
2. Generate (Immediate): Output the final, ready-to-import CSV blocks immediately. Do not output a draft or ask for confirmation.
1. Input Handling
I will provide:
‚Ä¢ Source Material: PDF notes or topic references.
‚Ä¢ Context: Subject & Exam Board (e.g., AQA A-Level Psychology).
‚Ä¢ Spec (Optional): AQA specification document or bullet points.
‚Ä¢ Title: Use the provided title or the PDF filename (contextualize all cards with this).
2. Processing & Spec Mapping (Internal Quality Control)
Before generating the CSVs, you must internally:
‚Ä¢ Extract & Clean: Identify headings, definitions, processes, diagrams, and AO3 evaluation.
‚Ä¢ Map to Spec: Ensure content matches the AQA specification.
‚Ä¢ Gap Handling: If a spec point is missing in the notes, do not invent detailed facts. Instead, create a card flagging the gap (e.g., Front: "Missing Spec Point: [Topic]", Back: "Refer to textbook/spec for [Details]").
3. Card Engineering Rules (Non-Negotiable)
A. General Quality Standards
‚Ä¢ AQA Full-Marks Standard: Every card must support a top-band answer (correct command word response, precise phrasing).
‚Ä¢ Detail Refinement Protocol: If notes are "thin," you must refine wording to meet A-Level standards using logic and inference without changing the core meaning. Do not add "nice-to-know" bloat, but ensure definitions include: Classification + Mechanism + Outcome.
‚Ä¢ No Duplicates: Merge or tweak rather than creating low-value variations.
‚Ä¢ Context: Every card Front must include the Notes Title.
B. Front/Back Contract (Strict Logic)
‚Ä¢ Point Locking: If Front asks for "N reasons," Back must have exactly N distinct bolded points. All other valid answers go to Extra.
‚Ä¢ Command Words:
‚Ä¢ Define: Classification + Mechanism.
‚Ä¢ Explain: Cause ‚Üí Effect chain.
‚Ä¢ Evaluate: Condition ‚Üí Mechanism ‚Üí Judgment (WELFATE/SMARTER criteria).
‚Ä¢ Diagrams (Econ/Bus): Front: "Draw [Diagram Name]." Back: "[Insert diagram]".
C. Card Types
Type 1: Basic Cards (Retention & Explanation)
‚Ä¢ Use for: Explanations, Processes, Comparisons, Diagrams.
‚Ä¢ Format: Front (Question) / Back (Short, bolded bullet points).
Type 2: Cloze Cards (Definitions & Lists)
‚Ä¢ Use for: Definitions, Formulae, Critical phrases, Ordered lists.
‚Ä¢ Format: Use Anki syntax {{c1::hidden text}}.
‚Ä¢ Calibration: Create 2‚Äì5 gaps per card to reconstruct the whole chain. Cloze the Verb, Object, or Qualifier. Do not over-clo
ze (maintain readability).
D. Special Protocol: Evaluation Cards (AO3)
‚Ä¢ No Label-Only Cards: Never have a card that just says "Time Lag." It must include the Description (Condition ‚Üí Mechanism ‚Üí Impact).
‚Ä¢ The Chunking Rule: Do not list 4+ full points on one card.
‚Ä¢ Total 3 points: Card A (2 described) + Card B (1 described + cues for others).
‚Ä¢ Total 4 points: Card A (2 described + cues) + Card B (2 described + cues).
‚Ä¢ Format: Front: "Evaluate [Topic] (2 points in full + identify others)." Back: 2 full points + "ID Only: [cue], [cue]".
‚Ä¢ The Summary Card: Always create one extra card: "Name all Evaluation points for [Topic] (State N)." (Labels only).
4. Output Instructions (Immediate CSV Generation)
You must output the final data immediately. You must strictly separate card types into two distinct CSV code blocks. Do not mix them.
Block 1: Basic Cards CSV
‚Ä¢ Code Fence: Use a dedicated code block for this.
‚Ä¢ Header: Front,Back,Extra,Tag
‚Ä¢ Content: Only Basic cards.
‚Ä¢ Formatting: Use <b> tags for highlighting in the Back field. Wrap fields containing commas/newlines in double quotes.
Block 2: Cloze Cards CSV
‚Ä¢ Code Fence: Use a separate, second code block for this.
‚Ä¢ Header: Front,Back,Extra,Tag
‚Ä¢ Content: Only Cloze cards.
‚Ä¢ Formatting: Back field contains {{c1::...}}. Wrap fields containing commas/newlines in double quotes.
Tag Format:
ModuleName Subtopic (Use underscores for spaces within names, space between Module and Subtopic). Example: Market_Failure Public_Goods.]
"""

# ==============================================================================
# 3. THE WORKFLOW (Fixed Logic)
# ==============================================================================
client = genai.Client(api_key=GEMINI_API_KEY)
# --- INJECTION 3: THE DIAGRAM GENERATOR FUNCTION ---
import io
import base64
import matplotlib.pyplot as plt
import numpy as np

def generate_diagram_base64(diagram_request):
    print(f"   üé® Generating Diagram: '{diagram_request}'...")
    try:
        # 1. Ask Gemini to write the code
        response = client.models.generate_content(
            model='gemini-2.5-pro',
            contents=f"Generate matplotlib code for: {diagram_request}",
            config=types.GenerateContentConfig(
                system_instruction=PROMPT_GRAPH_ENGINE,
                temperature=0.1 # Precise math
            )
        )

        # 2. Extract Code (Strip Markdown)
        code = response.text.replace("```python", "").replace("```", "").strip()

        # 3. Execute Code safely to a buffer
        plt.figure(figsize=(6, 4), dpi=100)
        # We pass local variables to exec() so it has access to plt/np
        exec(code, {'plt': plt, 'np': np})

        # 4. Save Image to Memory (Base64)
        buf = io.BytesIO()
        plt.savefig(buf, format='png', bbox_inches='tight')
        plt.close()
        buf.seek(0)
        img_str = base64.b64encode(buf.read()).decode('utf-8')

        # 5. Return HTML Image Tag
        return f'<div style="text-align:center; margin: 20px 0;"><img src="data:image/png;base64,{img_str}" style="max-width:100%; border:1px solid #ddd; border-radius:4px;"></div>'

    except Exception as e:
        print(f"   ‚ö†Ô∏è Diagram Failed ({diagram_request}): {e}")
        return f""

def run_workflow(topic):
    print(f"\nüöÄ STARTING WORKFLOW FOR: {topic}")
    print("-" * 50)

    # --- STEP 1: SEARCH ---
    print(f"üîé Step 1: Searching PMT/SaveMyExams...")

    # This is the NEW correct way to enable search using 'types'
    try:
        response = client.models.generate_content(
            model='gemini-2.5-pro',
            contents=PROMPT_1_FIND_SOURCE.format(topic=topic),
            config=types.GenerateContentConfig(
                tools=[types.Tool(google_search=types.GoogleSearch())],
                response_modalities=["TEXT"]
            )
        )
        print(f"DEBUG: Raw model response from Step 1 search: {response}") # Added debug print
        source_content = response.text
        if source_content is None or source_content == 'NO_SOURCE_FOUND':
            print(f"‚ùå Search Error: Model returned no text content or indicated no source for topic '{topic}'. This might mean no relevant source was found or the extraction failed.")
            # Attempt to extract content from tool_code if response.text is None but tools were used
            if response.candidates and response.candidates[0].content.parts:
                for part in response.candidates[0].content.parts:
                    if part.function_call and part.function_call.name == 'GoogleSearch':
                        # If the model intended to use GoogleSearch but didn't output text,
                        # we might need to inspect the tool outputs or adjust prompt.
                        print("DEBUG: Model's response included a GoogleSearch function call, but no text output.")
                        # For now, we will return as no text content was generated for 'source_content'
            return
        print(f"   ‚úÖ Source Found! (Length: {len(source_content)} chars)")
    except Exception as e:
        print(f"‚ùå Search Error: {e}")
        return

    # --- STEP 2: NOTES ---
print("üìù Step 2: Generating A* Notes...")
response = client.models.generate_content(
    model='gemini-2.5-pro',
    contents=PROMPT_2_CREATE_NOTES.format(source_text=source_content, topic=topic),
    config=types.GenerateContentConfig(temperature=0.2)
)
notes_text = response.text or ""

# --- STEP 2.5: DETECT & RENDER DIAGRAMS (FIXED) ---
print("üé® Step 2.5: Processing Diagrams...")

pattern = r"\{\{\s*DRAW\s*:\s*(.*?)\s*\}\}"
notes_text = re.sub(
    pattern,
    lambda m: generate_diagram_base64(m.group(1)),
    notes_text,
    flags=re.IGNORECASE
)



    # 2. Run the Substitution
    # This finds every match, extracts the name, runs 'generate_diagram_base64',
    # and replaces the text tag with the HTML image tag.
    notes_text = re.sub(
        pattern,
        lambda match: generate_diagram_base64(match.group(1)),
        notes_text
    )
print("DEBUG: any DRAW tags left?", "{{" in notes_text and "DRAW" in notes_text.upper())

    # --- (Start of Step 3: Saving Cornell HTML) ---
    # print(f"üíæ Step 3: Saving Cornell Notes as HTML...")
    # ...

    #: --- STEP 3: SAVE ---
                # --- STEP 3: SAVE AS CORNELL HTML (Ultra-Wide 10:90 Layout) ---
    print(f"üíæ Step 3: Saving Cornell Notes as HTML...")
    safe_topic = topic.replace(" ", "_").replace("/", "-")
    notes_filename = f"{drive_folder}/Cornell_{safe_topic}.html"

    # 1. Convert Markdown to basic HTML
    import markdown
    raw_html = markdown.markdown(notes_text)

    # 2. INJECT CORNELL LAYOUT (The Splitter Logic)
    import re

    # Wrapper function to split H3 headers into the Left Column
    def cornell_wrapper(match):
        header = match.group(1)
        content = match.group(2)
        return f'''
        <div class="cornell-row">
            <div class="cornell-cue"><h3>{header}</h3></div>
            <div class="cornell-note">{content}</div>
        </div>
        '''

    # Apply the logic: Find H3 -> Grab Content -> Wrap in Divs
    cornell_html = re.sub(r'<h3>(.*?)</h3>(.*?)(?=<h3>|$)', cornell_wrapper, raw_html, flags=re.DOTALL)

    # 3. CSS STYLING (Micro-Font + 10/90 Split)
    full_html_content = f"""
    <!DOCTYPE html>
    <html>
    <head>
        <title>{topic} - Cornell Notes</title>
        <style>
            /* Base Paper Style */
            body {{
                font-family: "Segoe UI", Helvetica, Arial, sans-serif;
                font-size: 10px; /* Tiny 50% Font */
                line-height: 1.3;
                background-color: #f4f6f9;
                color: #333;
                margin: 0; padding: 10px;
            }}

            /* The Sheet of Paper */
            .page-container {{
                max-width: 1200px;
                margin: 0 auto;
                background: white;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                padding: 20px;
                border-top: 4px solid #003366; /* Navy Blue */
            }}

            h1 {{
                text-align: center;
                border-bottom: 2px solid #003366;
                color: #003366;
                margin-bottom: 15px;
                font-size: 18px;
            }}

            /* CORNELL GRID LAYOUT */
            .cornell-row {{
                display: flex;
                border-bottom: 1px solid #e0e0e0;
                page-break-inside: avoid;
            }}

            /* Left Column: Cues/Headers (10% Width) */
            .cornell-cue {{
                width: 10%;  /* <--- CHANGED TO 10% */
                background-color: #f8f9fa;
                border-right: 2px solid #003366;
                padding: 8px;
                color: #003366;
                font-weight: bold;
                word-wrap: break-word; /* Critical for narrow columns */
                hyphens: auto;        /* Helps long words fit */
            }}
            .cornell-cue h3 {{ margin: 0; font-size: 1.1em; }}

            /* Right Column: Notes (90% Width) */
            .cornell-note {{
                width: 90%; /* <--- CHANGED TO 90% */
                padding: 8px 15px;
            }}

            /* Tighten lists */
            ul {{ margin: 0; padding-left: 15px; }}
            li {{ margin-bottom: 2px; }}

            strong {{ color: #003366; }}
        </style>
    </head>
    <body>
        <div class="page-container">
            <h1>üéì {topic}</h1>
            {cornell_html}
        </div>
    </body>
    </html>
    """

    with open(notes_filename, 'w') as f:
        f.write(full_html_content)
    print(f"   ‚úÖ Saved Cornell View: {notes_filename}")

    # --- STEP 4: ANKI ---
    print(f"üìá Step 4: Creating Anki Cards...")
    final_anki_prompt = f"{notes_text}\n\n{PROMPT_3_CREATE_ANKI}"

    response = client.models.generate_content(
        model='gemini-2.5-pro',
        contents=final_anki_prompt,
        config=types.GenerateContentConfig(temperature=0.2)
    )

    # Split the response text into potential CSV blocks
    # The model is instructed to output two CSV blocks, so we need to capture both.
    csv_blocks = response.text.split('```csv')

    basic_cards_csv = ""
    cloze_cards_csv = ""

    # Assuming the first non-empty block after splitting by '```csv' is Basic Cards
    # and the second is Cloze Cards, as per the new prompt structure.
    if len(csv_blocks) > 1:
        basic_cards_raw = csv_blocks[1].split('```')[0].strip()
        if basic_cards_raw:
            basic_cards_csv = basic_cards_raw

    # Check for the second CSV block (Cloze Cards)
    if len(csv_blocks) > 2:
        cloze_cards_raw = csv_blocks[2].split('```')[0].strip()
        if cloze_cards_raw:
            cloze_cards_csv = cloze_cards_raw

    # Save and download the Basic Cards CSV if generated
    if basic_cards_csv:
        basic_csv_filename = f"Anki_Basic_{safe_topic}.csv"
        with open(basic_csv_filename, 'w') as f:
            f.write(basic_cards_csv)
        files.download(basic_csv_filename)
        print(f"   ‚úÖ Downloaded Basic Cards: {basic_csv_filename}")
    else:
        print("   ‚ö†Ô∏è No Basic Cards CSV generated.")

    # Save and download the Cloze Cards CSV if generated
    if cloze_cards_csv:
        cloze_csv_filename = f"Anki_Cloze_{safe_topic}.csv"
        with open(cloze_csv_filename, 'w') as f:
            f.write(cloze_cards_csv)
        files.download(cloze_csv_filename)
        print(f"   ‚úÖ Downloaded Cloze Cards: {cloze_csv_filename}")
    else:
        print("   ‚ö†Ô∏è No Cloze Cards CSV generated.")

    if not basic_cards_csv and not cloze_cards_csv:
        print("‚ùå No Anki CSVs were generated at all. Please check the model's output.")
    else:
        print("üéâ Done!")

# ==============================================================================
# 4. RUN IT
# ==============================================================================
user_topic = input("Your AQA Topic ")
run_workflow(user_topic)
